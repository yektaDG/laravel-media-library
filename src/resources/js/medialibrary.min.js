class MediaLibrary{constructor(e){this.setParameters({selectedArray:[],hideOnAdd:!0,multipleSelect:!1,useId:1,libraryId:2,imagePreviewerId:2,useType:"imagePreview",limit:36,offset:0,isFirst:!0,responseBuffer:[],hasMore:!0,requestPending:!1,loadingButtonEl:null,sentinelEl:null,...e}),this.initAllTheMethods()}setParameters(e){Object.entries(e).forEach((e=>{this[e[0]]=e[1]}))}initAllTheMethods(){this.initEventForAddAndRemoveButton(),this.initMlButtonEvents(),this.initSaveFolderButton(),this.initRemoveFolderButton(),this.initMultiSelectModeButton(),this.initFolderDivEvents(),this.initModalEvent(),this.initDropZones(),this.useCallBack()}async insertNewItems(){await this.mlRefreshLibrary(this.responseBuffer),this.sentinelObserver.observe(this.sentinelEl),!1===this.hasMore&&(this.loadingButtonEl.style="display: none",this.sentinelObserver.unobserve(this.sentinelEl),this.listObserver.unobserve(this.loadingButtonEl)),this.loadingButtonEl.disabled=!0}async handleObserve(){!1===this.hasMore?(this.loadingButtonEl.style="display: none",this.sentinelObserver.unobserve(this.sentinelEl),this.listObserver.unobserve(this.loadingButtonEl)):(this.sentinelObserver.observe(this.sentinelEl),this.listObserver.observe(this.loadingButtonEl),this.loadingButtonEl.style="display: ''")}requestHandler(){if(this.requestPending)return;this.requestPending=!0;const e=$(`#library-folder-${this.libraryId} .folder-div.selected-folder .folder-hidden`).val();axios.get(this.allMediaRoute,{params:{limit:this.limit,offset:this.offset,folder:e}}).then((e=>{this.offset+=1,this.requestPending=!1,this.responseBuffer=Object.values(e.data.images).reverse(),this.hasMore=e.data.hasMore,this.loadingButtonEl.disabled=!1,this.isFirst&&($(`#infinite-scroll-button-${this.libraryId}`).trigger("click"),this.isFirst=!1)}))}sentinelObserver=this.generateSentinelObserver();generateSentinelObserver(){const e=this;return new IntersectionObserver(((t,s)=>{t.forEach((t=>{t.intersectionRatio>0&&(s.unobserve(e.sentinelEl),e.requestHandler())}))}))}listObserver=this.generateListObserver();generateListObserver(){const e=this;return new IntersectionObserver((t=>{t.forEach((t=>{t.intersectionRatio>0&&t.intersectionRatio<1&&e.insertNewItems().then((()=>{e.responseBuffer=[]}))}))}),{rootMargin:"0px 0px 200px 0px"})}initDropZones(){const e=this;$(".ml-dropzone").each(((t,s)=>{new Dropzone(`#${$(s).attr("id")}`,{url:e.dropzoneRoute??" ",headers:{"X-CSRF-TOKEN":e.csrf},paramName:"media-library-image",maxFiles:50,maxFilesize:10,method:"POST",addRemoveLinks:!0,success:(t,s)=>{e.mlAddSingleImage(s.media),setTimeout((()=>{t._removeLink.click()}),3e3)}}).on("sending",((e,t,s)=>{const i=$(".folder-div.selected-folder .folder-hidden").val();void 0!==i&&"gallery"!==i&&i.length>0&&s.append("folder",i)}))}))}initModalEvent(){const e=this,t=$(".media-library-modal");t.off("shown.bs.modal").on("shown.bs.modal",(async t=>{e.responseBuffer=[],e.libraryId=$(t.currentTarget).attr("libraryId"),e.initSearchFolder(),await e.mlGetAllFolders().then((async()=>{e.loadingButtonEl=document.querySelector(`#infinite-scroll-button-${e.libraryId}`),$(e.loadingButtonEl).off("click").on("click",(()=>{e.insertNewItems()})),e.sentinelEl=document.querySelector(`#sentinel-${e.libraryId}`),await e.handleObserve()}))})),t.off("hidden.bs.modal").on("hidden.bs.modal",(()=>{$(".library-row .selected").removeClass("selected"),$(`#add-media-${e.libraryId}`).addClass("disabled"),$("#gallery-folder").trigger("click"),e.hasMore=!1,e.handleObserve().then((()=>{e.hasMore=!0,e.isFirst=!0,e.offset=0,$(".th-div").remove()}))}))}initMlButtonEvents(){const e=this;$(".ml-button").off("click").on("click",(t=>{const s=t.currentTarget;e.useType=$(s).attr("useType"),e.useId=$(s).attr("useId")??$(s).closest("div").attr("id"),e.multipleSelect="true"===$(s).attr("multipleSelect"),e.hideOnAdd="true"===$(s).attr("hideOnAdd")||!$(s).attr("hideOnAdd"),e.showModal="false"!==$(s).attr("showModal"),!0===e.showModal&&$("#media-library").modal("show")})),$(".ml-remove-button").off("click").on("click",(t=>{const s=t.currentTarget;e.imagePreviewerId=$(s).closest("div").attr("id");const i=$("#"+e.imagePreviewerId).children(".lbox");i.attr("src",e.defaultImage),i.css("background-image","");let l="#"+e.imagePreviewerId+" .hidden-image-input";$(l).val("none").trigger("change")}))}initMultiSelectModeButton(){const e=this;$(`#multi-select-mode-${e.libraryId}`).on("change",(()=>{const t=$(`#add-media-${e.libraryId}`);$(this).is(":checked")&&"false"===e.multipleSelect?(t.prop("disabled",!0),t.closest("div").attr("data-bs-original-title",'برای استفاده از عکس ، حالت "انتخاب چندتایی" را غیر فعال کنید'),new bootstrap.Tooltip(t.closest("div"))):(t.prop("disabled",!1),t.closest("div").attr("data-bs-original-title",""),$(`#library-row-${e.libraryId} .selected`).each(((t,s)=>{0!==t&&($(s).removeClass("selected"),e.mlSetStyleToggle($(s).parent(".th-div"),!1))})))}))}initFolderDivEvents(){const e=this;$(".folder-div").off("click").on("click",(async t=>{const s=t.currentTarget;if(!$(s).hasClass("selected-folder")){const t=$(".selected-folder");t.removeClass("bg-gray-300").addClass("bg-gray-100"),t.find(".remove-folder").removeClass("btn-gray-300").addClass("btn-light"),t.find(".add-to-folder").removeClass("btn-gray-300 btn-active-light-warning").addClass("btn-light  btn-active-light-success").find("i").removeClass("fa-unlink").addClass("fa-plus"),t.removeClass("selected-folder"),$(s).addClass("selected-folder"),$(s).find(".remove-folder").removeClass("btn-light").addClass("btn-gray-300"),$(s).find(".add-to-folder").removeClass("btn-light btn-active-light-success").addClass("btn-gray-300 btn-active-light-warning").find("i").removeClass("fa-plus").addClass("fa-unlink"),$(s).removeClass("bg-gray-100").addClass("bg-gray-300"),e.offset=0,e.responseBuffer=[],e.hasMore=!0,$(".th-div").remove(),e.isFirst=!0,e.handleObserve().then((()=>{$(`#infinite-scroll-button-${e.libraryId}`).trigger("click")}))}}))}initSaveFolderButton(){const e=this;$(".ml-save-folder").off("click").on("click",(t=>{const s=t.currentTarget;t.preventDefault();const i=$(s).closest("div").find("input").val();e.folders.push({folder:`gallery-${i}`,uid:"_self"}),$(s).closest("div").find("input").val(""),$(s).closest(`#library-folder-${e.libraryId}`).find(".folders-list").append(`<div class="folder-div bg-gray-100 rounded mt-2 row "><div class="  p-1  ">\n                <input type="hidden" class="folder-hidden" value="gallery-${i}">\n                <div class=""><div class="col-md-6 text-center  mt-2 float-start">\n                <span class="ms-2"> ${i.replace("gallery-","")}</span></div>\n                <div class="mt-2 float-end"><div class="">\n                <button class="add-to-folder btn btn-sm btn-icon btn-light btn-active-light-success fa-pull-left d-inline-block">\n                <i class="fas fa-plus"></i></button>\n                <button id="delete"   class="remove-folder me-1 btn btn-sm btn-icon btn-light btn-active-light-danger fa-pull-left">\n                <span class="svg-icon svg-icon-5 m-0"><i class="text-dark-50 fonticon-trash fs-2"></i>\n                </span> </button></div></div>  </div></div></div>`),this.initRemoveFolderButton(),this.initFolderDivEvents(),this.initAddToFolderButton(),this.filterFolders("")}))}initSearchFolder(e=this.libraryId){const t=$(`#library-folder-name-${e}`),s=this;t.off("keyup").on("keyup",(()=>{s.filterFolders($(t).val())}))}initRemoveFolderButton(){const e=$(".remove-folder"),t=this;e.off("click").on("click",(s=>{s.preventDefault(),s.stopPropagation();const i=$(e).closest(".folder-div").find(".folder-hidden").val();t.removeFolderFromBackend(i,$(e).closest(".folder-div"))}))}initAddToFolderButton(){const e=this;$(".add-to-folder").off("click").on("click",(t=>{const s=t.currentTarget;t.preventDefault(),t.stopPropagation(),$(s).closest(".folder-div").hasClass("selected-folder")?e.removeFromFolder($(s).closest(".folder-div").find(".folder-hidden").val()):e.addToFolder($(s).closest(".folder-div").find(".folder-hidden").val())}))}initSelectThumbnailEvent(){const e=this;$(".th-div").off("click").on("click",(t=>{e.mlSelectThumbnail($(t.currentTarget).find(".img-thumbnail").attr("thumbnailId"))}))}removeFromFolder(e){const t=[],s=this,i=$(`#library-row-${this.libraryId} .selected`);i.each(((e,s)=>{const i=$(s).attr("id").split("thumbnail-")[1];t.push(i)})),axios.post(this.removeFromFolderRoute,{image_ids:t,folder_name:e}).then((()=>{s.removeImageFromRow(i),this.notifyToast(mlLang.notifyDelete)}))}notifyToast(e){const t=document.getElementById(`ml-toast-${this.libraryId}`);t.querySelector(".toast-body").innerHTML=e;bootstrap.Toast.getOrCreateInstance(t).show()}addToFolder(e){const t=[];$(`#library-row-${this.libraryId} .selected`).each(((e,s)=>{const i=$(s).attr("id").split("thumbnail-")[1];t.push(i)})),axios.post(this.moveToFolderRoute,{image_ids:t,folder_name:e}).then((()=>{this.notifyToast(mlLang.notifyAddToFolder)}))}removeFolderFromBackend(e,t){const s=this;Swal.fire({text:"آیا از حذف پوشه اطمینان دارید ؟ توجه کنید که عکس‌های درون پوشه حذف نمی شوند !",icon:"warning",showDenyButton:!0,buttonsStyling:!1,confirmButtonText:"حذف",denyButtonText:"لغو",customClass:{confirmButton:"btn btn-sm btn-danger",denyButton:"btn btn-sm btn-primary"}}).then((i=>{i.isConfirmed&&axios.post(s.destroyFolderRoute,{folder_name:e}).then((i=>{if(s.notifyToast(mlLang.notifyRemovedFolder),t.hasClass("selected-folder")){const e=$("#gallery-folder");e.addClass("selected-folder"),e.removeClass("bg-gray-100").addClass("bg-gray-300"),e.trigger("click"),s.offset=0,s.responseBuffer=[],s.hasMore=!0,$(".th-div").remove(),s.isFirst=!0,s.handleObserve().then((()=>{$(`#infinite-scroll-button-${s.libraryId}`).trigger("click")}))}s.folders=s.folders.filter((t=>t!==e)),t.remove()}))}))}async mlGetAllFolders(){const e=this;await axios.get(e.allFoldersRoute).then((t=>{e.folders=t.data,this.mlRefreshFolders(t.data)}))}filterFolders(e){const t=this.folders.filter((t=>t?.folder?.replace("gallery-","").includes(e)));this.mlRefreshFolders(t)}mlRefreshFolders(e){e=e.sort();const t=$(`#folders-list-div-${this.libraryId}`);t.html(""),t.append('<div class="folder-div rounded  bg-gray-300 selected-folder row " id="gallery-folder">\n                     <div class="col mt-2 p-1  "><input type="hidden" class="folder-hidden" data-user="auth"\n                                                                                     value="gallery" >\n                         <div class="row">\n                             <div class="col-md-7  pb-2  text-center"><span class="ms-2">گالری</span>\n                             </div>\n                             <div class="col">\n                             </div>\n                         </div>\n                     </div>\n                 </div>'),e.forEach((e=>{const s=e.folder,i=e.uid;t.append(`<div class="folder-div bg-gray-100 rounded mt-2 row "><div class="  p-1  "><input type="hidden" class="folder-hidden" data-user="${i}" value=" ${s}"><div class=""><div class="col-md-6 text-center  mt-2 float-start"><span class="ms-2">${s.replace("gallery-","")}</span> </div>\n <div class="mt-2 float-end"><div class=""> <button class="add-to-folder btn btn-sm btn-icon btn-light btn-active-light-success fa-pull-left d-inline-block"><i class="fas fa-plus"></i></button>\n  <button id="delete"\n                                                        class="remove-folder me-1 btn btn-sm btn-icon btn-light btn-active-light-danger fa-pull-left">\n                                                         <span class="svg-icon svg-icon-5 m-0">\n                                                                     <i class="text-dark-50 fonticon-trash fs-2"></i>\n                                                                 </span> </button></div></div></div></div></div>`)})),this.initRemoveFolderButton(),this.initAddToFolderButton(),this.initFolderDivEvents()}mlSelectThumbnail(e){const t=$(`#library-row-${this.libraryId} #thumbnail-${e}`),s=this;if(t.hasClass("selected"))t.removeClass("selected"),this.mlSetStyleToggle($(t).closest(".th-div"),!1),this.mlCheckSelected(),this.selectedArray=this.selectedArray.filter((e=>e!==t));else{if(!$(`#multi-select-mode-${this.libraryId}`).is(":checked")){const e=[];$(`#library-row-${this.libraryId} .selected`).each(((t,i)=>{$(i).removeClass("selected"),s.mlSetStyleToggle($(i).parent(".th-div"),!1),e.push(i)})),this.selectedArray=this.selectedArray.filter((t=>!e.includes(t)))}t.addClass("selected"),this.mlSetStyleToggle($(t).closest(".th-div"),!0),this.mlCheckSelected(),this.selectedArray.push(t)}}mlSetStyleToggle(e,t){t?(e.find(".m-over").addClass("m-over-selected"),e.find(".th-info").addClass("th-info-selected"),e.find(".th-info-button").addClass("th-info-button-selected")):(e.find(".m-over").removeClass("m-over-selected"),e.find(".th-info").removeClass("th-info-selected"),e.find(".th-info-button").removeClass("th-info-button-selected"))}mlShowThumbnailInfo(e){let t=parseInt(e.size);return t=parseFloat(t/1024).toFixed(2),`<div class="th-info-details">\n        <div class="justify-content-center text-center mb-5"><span class="d-inline-block fw-boldest">جزییات</span> </div>\n        <p  class="text-center fw-bold" style="word-wrap: break-word"> ${e.filename} </p>\n        <p id="alt-info-${e.id}" class="text-center fw-bold" > <i class="fa fa-info-circle ">\n        </i> : ${e.alt}</p><p class="text-center fw-bold"> ${e.created_date}  در  ${e.created_at.substring(11,19)} </p>\n         <p class="text-center fw-bold"> کیلو بایت  ${t} </p> <p class="text-center fw-bold"> پیکسل ${e.width}   *  ${e.height} </p>  <br>\n         <div class="input-group input-group-sm justify-content-center mt-2 px-1" >   <input id="alt-input" type="text"  value="${e.alt}" class="form-control form-control-sm fs-8"  placeholder="Alt را وارد کنید">\n         <button type="button" class="setAlt-btn btn btn-light btn-sm fs-8">ذخیره</button> </div></div>`}setAlt(e){const t=$("#alt-input").val();axios.post(this.setAltRoute,{id:e,alt_value:t}).then((s=>{200===s.status&&(this.notifyToast(mlLang.notifyChangeAlt),$(`#alt-info-${e}`).html(`\n                          <i class="fa fa-info-circle "> </i> :  ${t} `))}))}initEventForAddAndRemoveButton(){const e=this;$(".ml-add-button").off("click").on("click",(()=>{e.mlAddMediaForUsage()})),$(".ml-delete-button").off("click").on("click",(()=>{Swal.fire({title:mlLang.confirmText,text:mlLang.confirmText2,icon:"warning",showCancelButton:!0,customClass:{confirmButton:"btn btn-light-danger btn-sm",cancelButton:"btn btn-light btn-sm"},buttonsStyling:!1,cancelButtonText:mlLang.cancelButton,confirmButtonText:mlLang.confirmButton}).then((t=>{t.isConfirmed&&e.mlDeleteMedia()}))}))}mlCheckSelected(){const e=$(`#library-row-${this.libraryId} .selected`),t=$(`#add-media-${this.libraryId} `),s=$(`#delete-media-${this.libraryId}`);e.length>0?(t.removeClass("disabled"),s.removeClass("disabled")):(t.addClass("disabled"),s.addClass("disabled"))}async mlAddMediaForUsage(){const e=this,t=$(`#library-row-${this.libraryId} .selected`),s=()=>{let t="";for(let s=0;s<this.selectedArray.length;s++){const i=e.selectedArray[s];t+=`<img alt="${$(i).attr("alt")}" src="${$(i).attr("imageurl")}" style="max-width: 1024px"/>`}tinymce.get(e.useId).execCommand("mceInsertContent",!1,t),e.mlUnselectThumbnails()};if(t.length>0)switch(this.useType){case"hidden":(()=>{const s=document.getElementById(e.useId);for(let e=0;e<t.length;e++)s.value+=`${t[e].getAttribute("imageurl")},`;s.dispatchEvent(new Event("change"))})();break;case"tinymce":await s(),this.selectedArray=[];break;case"imagePreview":(()=>{const s=$(`#${e.useId} .lbox`);s.css({"background-image":""});const i=t[t.length-1].getAttribute("imageurl");s.attr("src",i),$(`#${e.useId} .hidden-image-input`).val(i).trigger("change")})()}!0===this.hideOnAdd?($("#media-library").modal("hide"),this.notifyToast(mlLang.notifyAdd)):this.notifyToast(mlLang.notifyAddToTinymce)}async mlUnselectThumbnails(){const e=this;await $(`#library-row-${this.libraryId} .selected`).each(((t,s)=>{$(s).removeClass("selected"),e.mlSetStyleToggle($(s).parent(".th-div"),!1)})),e.selectedArray=[],await e.mlCheckSelected()}mlDeleteMedia(){const e=$(".library-row .selected"),t=this,s=[];for(let t=0;t<e.length;t++){let i=e[t].id;$(`#${i}`).removeClass("selected"),i=i.substring(3),s.push(i)}axios.post(this.removeMediaRoute,{media_ids:s}).then((async s=>{200===s.status&&(t.selectedArray=[],await t.removeImageFromRow(e),t.mlCheckSelected(),this.notifyToast(mlLang.notifyDelete))}))}removeImageFromRow(e){e.each(((e,t)=>{$(t).closest(".th-div").remove()}))}mlAddSingleImage(e){const t=document.querySelector(`#library-row-${this.libraryId}`),s=document.querySelector(`#library-row-${this.libraryId} .th-div:first-child`),i=[],l={},n=`storage/${e.directory}/${e.filename}-139x-${e.extension}`,a=e.id,o=this;i.push({id:a,element:"",url:n}),l[a]=e,axios.post(this.imageExistRoute,{images:i}).then((e=>{e.data.forEach((e=>{const i=l[e.id];let n=`/storage/${i.directory}/${i.filename}`;!0===e.element?n+=`-139x-${i.extension}`:n+="."+i.extension;const a=`/storage/${i.directory}/${i.filename}.${i.extension}`,r=document.createElement("div");r.classList.add("th-div"),r.innerHTML=`  <img id="thumbnail-${i.id}"  thumbnailId="${i.id}" src="${n}"\n                alt="image" class="padding-0 img-thumbnail "  imageUrl="${a}"><div class="m-over"></div>\n                <span type="button" thumbnailId="${i.id}" class="fw-bold btn th-info-button p-0 "><i class="far fa-edit  fs-5"></i></span>\n                <div class="th-info "><span class="fw-bolder th-text">${i.filename}</span><span class="fw-bold th-text">${i.alt}</span></div>`,t.insertBefore(r,s),$(r).on("click",(()=>{o.mlSelectThumbnail($(r).find(".img-thumbnail").attr("thumbnailId"))})),$(r).find(".th-info-button").on("click",(e=>{const t=$(`#library-info-${o.libraryId}`);e.stopPropagation(),$(t).hasClass("show-image-info")?$(r).attr("thumbnailId")!==t.attr("openedBy")?o.mlOpenInfo(t,$(r)):o.mlCloseInfo(t):o.mlOpenInfo(t,$(e.currentTarget))}))}))}))}mlRefreshLibrary(e){const t=document.querySelector(`#library-row-${this.libraryId}`),s=[],i={},l=this;e.forEach((e=>{const t=`storage/${e.directory}/${e.filename}-139x-${e.extension}`,l=e.id;s.push({id:l,element:"",url:t}),i[l]=e})),axios.post(this.imageExistRoute,{images:s}).then((e=>{e.data.forEach((e=>{const s=i[e.id],n=`/storage/${s.directory}/${s.filename}${!0===e.element?"-139x-"+s.extension:"."+s.extension}`,a=`/storage/${s.directory}/${s.filename}.${s.extension}`,o=document.createElement("div");o.classList.add("th-div"),o.innerHTML=`  <img id="thumbnail-${s.id}"  thumbnailId="${s.id}" src="${n}"\n\n            alt="${s.alt}" class="padding-0 img-thumbnail "  imageUrl="${a}">\n                          <div class="m-over"></div>\n                                    <span type="button" thumbnailId="${s.id}" class="fw-bold btn th-info-button p-0 "><i class="far fa-edit  fs-5"></i></span>\n                        <div class="th-info ">\n                                    <span class="fw-bolder th-text">${s.filename}</span>\n                                    <span class="fw-bold th-text">${s.alt}</span></div>    `,t.insertBefore(o,l.sentinelEl)}))})).then((()=>{l.initSelectThumbnailEvent(),l.initShowInfoButton()})).catch()}initShowInfoButton(){const e=$(`#library-info-${this.libraryId}`),t=this;$(".th-info-button").off("click").on("click",(s=>{const i=s.currentTarget;s.stopPropagation(),$(e).hasClass("show-image-info")?$(i).attr("thumbnailId")!==e.attr("openedBy")?t.mlOpenInfo(e,$(i)):t.mlCloseInfo(e):t.mlOpenInfo(e,$(i))}))}mlOpenInfo(e,t){const s=this;$(`#thumbnail-${e.attr("openedBy")}`).removeClass("selected-th-info"),e.attr("openedBy",t.attr("thumbnailId")),e.removeClass("close-image-info"),e.addClass("show-image-info"),t.closest(".th-div").find("#thumbnail-"+t.attr("thumbnailId")).addClass("selected-th-info");let i="";axios.post(this.mediaSingleRoute,{id:t.attr("thumbnailId")}).then((t=>{200===t.status&&(i=s.mlShowThumbnailInfo(t.data),e.html(i),e.find(".th-info-details").removeClass("d-none"),$(`#details-body-${s.libraryId}`).collapse("show"),$(".th-info-details").find(".setAlt-btn").off("click").on("click",(()=>{s.setAlt(t.data.id)})))}))}mlCloseInfo(e){$(`#thumbnail-${e.attr("openedBy")}`).removeClass("selected-th-info"),e.find(".th-info-details").addClass("d-none"),e.attr("openedBy",""),e.removeClass("show-image-info"),e.addClass("close-image-info")}useCallBack(){"undefined"!=typeof mediaLibraryCallBack&&mediaLibraryCallBack(this)}}